{"version":3,"file":"index.js","sources":["../src/constants.js","../src/index.js"],"sourcesContent":["export const ROLLBAR_ENDPOINT = 'https://api.rollbar.com/api/1/sourcemap'\n\nexport const ROLLBAR_REQ_FIELDS = [\n  'accessToken',\n  'baseUrl',\n  'version'\n]\n","// Custom rollup plugin for uploading rollbar deploys\nimport FormData from 'form-data'\nimport { existsSync, readFileSync } from 'fs'\nimport { resolve } from 'path'\nimport glob from 'fast-glob'\nimport fetch from 'node-fetch-native'\nimport VError from 'verror'\nimport { ROLLBAR_ENDPOINT } from './constants'\n\nasync function uploadSourcemap(form, { filename, rollbarEndpoint, silent }) {\n  const errMessage = `Failed to upload ${filename} to Rollbar`\n\n  let res\n  try {\n    res = await fetch(rollbarEndpoint, {\n      method: 'POST',\n      body: form\n    })\n  } catch (err) {\n    // Network or operational errors\n    throw new VError(err, errMessage)\n  }\n\n  // 4xx or 5xx response\n  if (!res.ok) {\n    // Attempt to parse error details from response\n    let details\n    try {\n      const body = await res.json()\n      details = body?.message ?? `${res.status} - ${res.statusText}`\n    } catch (parseErr) {\n      details = `${res.status} - ${res.statusText}`\n    }\n\n    throw new Error(`${errMessage}: ${details}`)\n  }\n\n  // Success\n  if (!silent) {\n    console.info(`Uploaded ${filename} to Rollbar`)\n  }\n}\n\nexport default function rollbarSourcemaps({\n  accessToken,\n  version,\n  baseUrl,\n  silent = false,\n  ignoreUploadErrors = true,\n  rollbarEndpoint = ROLLBAR_ENDPOINT,\n  base = '/',\n  outputDir = 'dist'\n}) {\n  return {\n    localProps: {\n      accessToken,\n      version,\n      baseUrl,\n      silent,\n      rollbarEndpoint\n    },\n    name: 'vite-plugin-rollbar',\n    async writeBundle() {\n      const files = await glob('./**/*.map', { cwd: outputDir })\n      const sourcemaps = files\n        .map((file) => {\n          const sourcePath = file.replace(/\\.map$/, '')\n          const sourceFilename = resolve(outputDir, sourcePath)\n\n          if (!existsSync(sourceFilename)) {\n            console.error(`No corresponding source found for '${file}'`, true)\n            return null\n          }\n\n          const sourcemapLocation = resolve(outputDir, file)\n\n          try {\n            return {\n              content: readFileSync(sourcemapLocation, 'utf8'),\n              sourcemap_url: sourcemapLocation,\n              original_file: `${base}${sourcePath}`\n            }\n          } catch (error) {\n            console.error(\n              `Error reading sourcemap file ${sourcemapLocation}: ${error}`,\n              true\n            )\n            return null\n          }\n        })\n        .filter((sourcemap) => sourcemap !== null)\n\n      if (!sourcemaps.length) return\n\n      try {\n        await Promise.all(\n          sourcemaps.map((asset) => {\n            const form = new FormData()\n            form.append('access_token', accessToken)\n\n            form.append('version', version)\n            form.append('minified_url', `${baseUrl}${asset.original_file}`)\n            form.append('source_map', asset.content, {\n              filename: asset.original_file,\n              contentType: 'application/json'\n            })\n            return uploadSourcemap(form, {\n              filename: asset.original_file,\n              rollbarEndpoint,\n              silent\n            })\n          })\n        )\n      } catch (error) {\n        if (ignoreUploadErrors) {\n          console.error('Uploading sourcemaps to Rollbar failed: ', error)\n          return\n        }\n        throw error\n      }\n    }\n  }\n}\n"],"names":["fetch","VError","glob","resolve","existsSync","readFileSync","FormData"],"mappings":"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"}